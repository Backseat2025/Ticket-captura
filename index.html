<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Subir foto â€” Preview y webhook</title>
  <style>
    :root{--bg:#f7f8fb;--card:#ffffff;--accent:#5b21b6;--muted:#6b7280}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:linear-gradient(180deg,var(--bg),#fff); color:#111}
    .wrap{max-width:720px;margin:36px auto;padding:18px}
    header{display:flex;align-items:center;gap:12px;margin-bottom:18px}
    header h1{font-size:18px;margin:0}
    .card{background:var(--card);border-radius:14px;padding:18px;box-shadow:0 6px 18px rgba(16,24,40,0.06)}
    .preview{display:grid;grid-template-rows:auto 1fr;gap:12px}
    .preview img{width:100%;height:auto;border-radius:10px;object-fit:cover;background:#efefef}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .btn{appearance:none;border:0;padding:10px 14px;border-radius:10px;font-weight:600;background:linear-gradient(90deg,var(--accent),#7c3aed);color:#fff;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid #e6e6f0;color:var(--accent);font-weight:600}
    .small{font-size:13px;color:var(--muted)}
    input[type=file]{display:none}
    .hint{display:flex;gap:10px;align-items:center;margin-top:8px}
    progress{width:100%;height:8px;border-radius:8px}
    @media (max-width:480px){.wrap{margin:18px;padding:12px}.btn{flex:1}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <svg width="36" height="36" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="24" height="24" rx="6" fill="#7c3aed"/><path d="M7 10c1.5-2 4-2 5 0 1-1 2.5-1 3 1v4H6v-5z" fill="white" opacity=".95"/></svg>
      <h1>Subir foto (mÃ³vil) â€” Preview & enviar a webhook</h1>
    </header>

    <div class="card">
      <div class="preview">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <strong>Preview</strong>
            <div class="small">Toma una foto o elige desde la galerÃ­a</div>
          </div>
          <div class="small" id="fileInfo"></div>
        </div>

        <img id="imgPreview" alt="preview" src="" style="display:none" />

        <div style="display:flex;flex-direction:column;gap:8px">
          <label class="controls">
            <label for="fileInput" class="btn" style="cursor:pointer">ðŸ“¸ Tomar / Elegir foto</label>
            <button id="sendBtn" class="btn ghost" disabled>Enviar al webhook</button>
            <button id="clearBtn" class="btn ghost" style="display:none">Limpiar</button>
          </label>

          <input id="fileInput" type="file" accept="image/*" capture="environment" />

          <div class="hint small">Nota: reemplaza la constante <code>WEBHOOK_URL</code> en el cÃ³digo con tu webhook de Make. Si ves un error CORS, usa un proxy o una funciÃ³n de servidor.</div>
          <progress id="uploadProgress" value="0" max="100" style="display:none"></progress>
          <div id="status" class="small"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- CONFIG: reemplaza con tu webhook de Make ---
    const WEBHOOK_URL = 'https://hook.integromat.com/REEMPLAZA_POR_TU_WEBHOOK';

    const fileInput = document.getElementById('fileInput');
    const imgPreview = document.getElementById('imgPreview');
    const sendBtn = document.getElementById('sendBtn');
    const clearBtn = document.getElementById('clearBtn');
    const fileInfo = document.getElementById('fileInfo');
    const status = document.getElementById('status');
    const progressBar = document.getElementById('uploadProgress');

    let selectedFile = null;

    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return reset();
      // show file info
      fileInfo.textContent = `${Math.round(file.size/1024)} KB`;

      // Optional: resize image on client to limit size (keeps orientation basic)
      try {
        const resizedBlob = await resizeImage(file, 1280); // max width
        selectedFile = new File([resizedBlob], file.name, { type: resizedBlob.type });
      } catch (err) {
        // fallback to original file
        selectedFile = file;
      }

      imgPreview.src = URL.createObjectURL(selectedFile);
      imgPreview.style.display = 'block';
      sendBtn.disabled = false;
      clearBtn.style.display = 'inline-block';
      status.textContent = '';
    });

    clearBtn.addEventListener('click', (e) => { e.preventDefault(); reset(); });

    sendBtn.addEventListener('click', async () => {
      if (!selectedFile) return;
      sendBtn.disabled = true;
      progressBar.style.display = 'block';
      progressBar.value = 0;
      status.textContent = 'Enviando...';

      // Prepare form data
      const form = new FormData();
      form.append('file', selectedFile);
      // Puedes aÃ±adir mÃ¡s campos si Make los necesita
      form.append('filename', selectedFile.name);

      try {
        // Fetch simple POST â€” Make usually acepta multipart/form-data webhooks
        const resp = await fetch(WEBHOOK_URL, {
          method: 'POST',
          body: form,
          // no content-type header: browser sets boundary automatically
        });

        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);

        status.textContent = 'Enviado correctamente âœ…';
        progressBar.value = 100;
      } catch (err) {
        console.error(err);
        status.textContent = `Error: ${err.message}. Si es CORS, prueba con un proxy o funciÃ³n de servidor.`;
      } finally {
        sendBtn.disabled = false;
        setTimeout(()=>{ progressBar.style.display='none'}, 1200);
      }
    });

    function reset(){
      selectedFile = null;
      imgPreview.src = '';
      imgPreview.style.display = 'none';
      fileInput.value = '';
      sendBtn.disabled = true;
      clearBtn.style.display = 'none';
      fileInfo.textContent = '';
      status.textContent = '';
      progressBar.style.display = 'none';
    }

    // Resize helper - returns a Blob of resized image (JPEG)
    function resizeImage(file, maxWidth = 1280){
      return new Promise((resolve, reject) => {
        const img = new Image();
        const url = URL.createObjectURL(file);
        img.onload = () => {
          let { width, height } = img;
          if (width <= maxWidth) {
            URL.revokeObjectURL(url);
            // keep original
            file.arrayBuffer().then(buf => resolve(new Blob([buf], { type: file.type }))).catch(reject);
            return;
          }
          const ratio = maxWidth / width;
          const canvas = document.createElement('canvas');
          canvas.width = Math.round(width * ratio);
          canvas.height = Math.round(height * ratio);
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          canvas.toBlob((blob) => {
            URL.revokeObjectURL(url);
            if (blob) resolve(blob); else reject(new Error('No se pudo convertir a blob'));
          }, 'image/jpeg', 0.85);
        };
        img.onerror = (e) => { URL.revokeObjectURL(url); reject(e); };
        img.src = url;
      });
    }
  </script>
</body>
</html>
